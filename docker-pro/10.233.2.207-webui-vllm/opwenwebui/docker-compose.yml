services:

  # OpenWebUI 服务
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    ports:
      - "3000:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./data:/app/backend/data
    restart: always

  # ⭐ OpenWebUI Pipelines 服务 ⭐
  pipelines:
    image: ghcr.io/open-webui/pipelines:main
    container_name: openwebui-pipelines
    ports:
      - "9099:9099"
    environment:
      - PIPELINES_API_KEY=123456
    volumes:
      - ./pipelines:/app/pipelines
    restart: always


  # Monitor 使用的数据库 (PostgreSQL)
  db:
    image: postgres:15-alpine
    container_name: monitor-db
    expose:
      - "5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=openwebui
      - POSTGRES_DB=openwebui_monitor
    volumes:
      - ./monitor-db-data:/var/lib/postgresql/data
    restart: always

  # OpenWebUI-Monitor 服务
  monitor:
    build:
      context: ./OpenWebUI-Monitor
    container_name: openwebui-monitor
    ports:
      - "7878:3000"   # Monitor 内部默认是 3000 (Dockerfile里 EXPOSE 3000)；DeepWiki 文档里也说 Monitor 会在 7878 对外。 :contentReference[oaicite:0]{index=0}  
    env_file:
      - ./OpenWebUI-Monitor/.env
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=openwebui
      - POSTGRES_DATABASE=openwebui_monitor
    depends_on:
      - openwebui
      - db
    restart: always

  filesystem-server:
    build:
      context: ./openapi-servers/servers/filesystem
    ports:
      - 8081:8000
    restart: always
  memory-server:
    build:
      context: ./openapi-servers/servers/memory
    ports:
      - 8082:8000
    volumes:
      - memory:/app/data:rw
  time-server:
    build:
      context: ./openapi-servers/servers/time
    ports:
      - 8083:8000

volumes:
  memory:
